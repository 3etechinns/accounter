<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
                "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
                "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping package="com.vimukti.accounter.core"
	default-access="field" auto-import="false">

	<query name="get.All.InventoryItem">
		<query-param name="companyId" type="long"/>
		from com.vimukti.accounter.core.Item it where it.company.id=:companyId and it.type in (2,4) 
	</query>

	<sql-query name="getNextAccountNumber">
		<query-param name="companyId" type="long" />
		<query-param name="subbaseType" type="int" />
		
		<return-scalar column="A_NUMBER" type="encryptedstring" />
		
		<![CDATA[
				SELECT A_NUMBER
				FROM   ACCOUNT A
				WHERE  SUB_BASE_TYPE = :subbaseType
				       AND A.COMPANY_ID = :companyId  
				]]>

	</sql-query> 
	
	<query name="get.AssetsAccountOfCompany">
		<query-param name="companyId" type="long"/>
		from com.vimukti.accounter.core.Account a where a.company.id=:companyId and a.type=5
	</query>
	
	<query name="get.Account.by.Name">
		<query-param name="companyId" type="long"/>
		<query-param name="accountName" type="String"/>
		from com.vimukti.accounter.core.Account a where a.name=:accountName and a.company.id=:companyId
	</query>
	
	<query name="getAccountTransactions">
		<query-param name="companyId" type="long"/>
		<query-param name="accountId" type="long"/>
		from com.vimukti.accounter.core.AccountTransaction at where at.account.id=:accountId and at.company.id=:companyId
	</query>
	
	<query name="get.AccountTransaction.Of.Item">
		<query-param name="itemId" type="long"/>
		select at from com.vimukti.accounter.core.AccountTransaction  at left join at.transaction.transactionItems as ti
		where ti.type=1 and ti.item.id=:itemId and 
		(at.account.id=ti.item.expenseAccount.id or at.account.id=ti.item.assestsAccount.id) and 
		(at.transaction.type in (1,14,8,37) or (at.transaction.type=36 and ti.quantity.value &lt; 0))
	</query>
	
	<sql-query name="delete.InventoryPurchases.Of.Company">
		<query-param name="companyId" type="long" />
		
		<![CDATA[
				DELETE FROM INVENTORY_PURCHASE IP
				USING  TRANSACTION_ITEM,
				       TRANSACTION
				WHERE  TRANSACTION_ITEM_ID = TRANSACTION_ITEM.ID
				       AND TRANSACTION_ITEM.TRANSACTION_ID = TRANSACTION.ID
				       AND TRANSACTION.COMPANY_ID = :companyId  
				]]>
		
	</sql-query>	
	
	<query name="get.AccountTransactions.Of.AccountReceivables">
		<query-param name="companyId" type="long" />
		from com.vimukti.accounter.core.AccountTransaction at 
		where at.account.id=at.company.accountsReceivableAccount.id and at.company.id=:companyId
	</query>
	
	<query name="get.AccountTransactions.Of.AccountPayables">
		<query-param name="companyId" type="long" />
		from com.vimukti.accounter.core.AccountTransaction at 
		where at.account.id=at.company.accountsPayableAccount.id and at.company.id=:companyId
	</query>
	
	<query name="getAllTransactionOfCompany">
		<query-param name="company" type="Company" />
		from com.vimukti.accounter.core.Transaction t  where t.company=:company and t.saveStatus not in (201,202,204) order by t.type, t.id
	</query>
	
	
	<query name="getNextCompany">
		<query-param name="companyId" type="long" />
		from com.vimukti.accounter.core.Company c where c.version!=7 and 
		c.isConfigured=true and isLocked=false and c.id &gt; :companyId  order by id
	</query>
	
	<query name="getAccountTransactionsOfVoidTransaction">
		<query-param name="company" type="Company" />
		from com.vimukti.accounter.core.AccountTransaction at where at.transaction.saveStatus in (201,202,204) and at.company=:company
	</query>
	
	<query name="get.All.TdsChallans">
		<query-param name="company" type="Company" />
		from com.vimukti.accounter.core.TDSChalanDetail tc where
		tc.company=:company
	</query>

	<query name="get.all.Items">
		<query-param name="company" type="Company" />
		from com.vimukti.accounter.core.Item it where it.type in(2,4) and it.company=:company
	</query>

	<sql-query name="get.all.inventory.items.transactions">
		<query-param name="companyId" type="long" />
		<return-scalar column="T_ID" type="long" />
		<![CDATA[
			SELECT t.id AS T_ID 
			FROM   TRANSACTION t 
			       LEFT JOIN transaction_item ti 
			              ON ti.transaction_id = t.id 
			       LEFT JOIN item i 
			              ON i.id = ti.item_id 
			WHERE  t.company_id = :companyId 
			       AND t.save_status NOT IN ( 201, 202, 204 ) 
			       AND ( i.type = 2 ) 
			GROUP  BY t.id 
			ORDER  BY t.t_type, 
			          t.id 
			]]>
	</sql-query>

	<query name="getItemsOfAverageCostZero">
		<query-param name="company" type="Company" />
		from com.vimukti.accounter.core.Item i where i.averageCost=0 and i.company=:company
	</query>
	
	<query name="getInventoryOfAverageCostNegative">
		<query-param name="company" type="company"/>
		from com.vimukti.accounter.core.Item i where i.type in (2,4) and i.averageCost &lt; 0 and i.company=:company
	</query>
	
	<sql-query name="make.all.accounttransaction.can.updateaccount">
		<query-param name="company" type="Company"/>
		UPDATE ACCOUNT_TRANSACTION SET UPDATE_ACCOUNT=TRUE WHERE UPDATE_ACCOUNT=FALSE; 
	</sql-query>
</hibernate-mapping>