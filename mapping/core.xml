<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD//EN" "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping package="com.bizantra.server.internal.core"
	default-access="field">

	<!--

		protected Date createdDate; protected Strrty name="spaceID"
		length="40" index="COMMAND_DATA_SPACE_INDEX" not-null="true"
		column="SPACE_ID" unique-key="MEMBER_VERSIOing creator; protected Long
		id; protected Date lastModifiedDate; protected String lastModifier;

		protected int lastModifierDevice;
	-->


	<class name="com.vimukti.accounter.ext.Command" table="COMMAND">
		<id name="id" access="property" column="ID">
			<generator class="native" />
		</id>
		<property name="command" column="COMMAND">
		</property>
		<property name="arg1" column="ARG1">
		</property>
		<property name="arg2" column="ARG2">
		</property>
		<property name="date" column="DATE">
		</property>
		<many-to-one name="next" class="com.bizantra.server.ext.Command"
			cascade="save-update,delete,evict" lazy="false" column="NEXTCOMMAND">
		</many-to-one>
	</class>


	<class name="IdentityDevice" table="IDENTITY_DEVICES">
		<id name="id" column="ID">
			<generator class="native">
			</generator>
		</id>
		<property name="identity" type="string" column="IDENTITY_ID">
		</property>
		<property name="name" type="string" column="NAME">
		</property>
		<property name="status" type="string" column="status">
		</property>
		<property name="lastConnectedDate" column="LAST_CONNECTED_DATE">
		</property>
		<property name="loginDate" column="LOGINDATE">
		</property>
		<property name="deviceID" type="int" column="deviceID">
		</property>
		<property name="lastSynAchivedDate" column="LAST_SYNACHIVED_DATE">
		</property>
	</class>



	<class name="DeletedUser" table="DELETED_USER">
		<id name="userId" column="USER_ID">
			<generator class="assigned">
			</generator>
		</id>

		<property name="name" column="NAME">
		</property>
		<property name="emailId" column="EMAIL_ID">
		</property>
		<property name="companyName" column="COMPANY_NAME">
		</property>

	</class>
	<!--
		<class name="com.bizantra.server.workspace.SharedServerDetails"
		table="SHARED_SERVER_DETAILS"> <id name="companyName"
		column="COMPANY_NAME"> <generator class="assigned"></generator> </id>


		<property name="serverName" column="SERVER_NAME"></property> <set
		name="sharedWorkspaces" cascade="all" lazy="false"> <key
		column="COMPANY_NAME_ID" /> <one-to-many
		class="com.bizantra.server.workspace.SharedWorkspaces" /> </set>

		</class> <class name="com.bizantra.server.workspace.SharedWorkspaces"
		table="SHARED_WORKSPACES"> <id name="id" column="ID"> <generator
		class="native"></generator> </id> <many-to-one name="companyName"
		class="com.bizantra.server.workspace.SharedServerDetails" lazy="false"
		column="COMPANY_NAME_ID"></many-to-one> <property
		name="sharedWorkspace" column="SHARED_WORKSPACE"></property> </class>
	-->

	<!--
		<class name="com.bizantra.server.workspace.SharedServerDetails"
		table="SHARED_SERVER_DETAILS"> <id name="id" unsaved-value="0">
		<generator class="increment"/> </id> <set name="sharedWorkspaces"
		cascade="all" inverse="true"> <key column="COMPANY_NAME_ID"/>
		<one-to-many class="com.bizantra.server.workspace.SharedWorkspaces"/>
		</set> <property name="serverName" column="SERVER_NAME"></property>
		<property name="companyName" column="COMPANY_NAME"></property>
		</class> <class name="com.bizantra.server.workspace.SharedWorkspaces"
		table="SHARED_WORKSPACES"> <id name="id" unsaved-value="0"> <generator
		class="increment"/> </id> <property name="sharedWorkspace"
		column="SHARED_WORKSPACE"></property> <many-to-one name="companyName"
		column="COMPANY_NAME_ID" not-null="true"/> </class>
	-->





	<!--	 Named SQL for class CollaberIdentity -->


	<sql-query name="getsystemrole">
		<query-param name="ID" type="string" />
		SELECT SYSTEM_ROLE FROM COLLABERIDENTITY WHERE
		ID=:ID
	</sql-query>
	<sql-query name="identityStateMap">
		<query-param name="id" type="string" />
		SELECT DISTINCT DEVICEID ,MAX(VERSION) FROM IDENTITYCOMMAND WHERE
		IDENTITY_ID=:id GROUP BY DEVICEID ORDER BY DEVICEID
	</sql-query>
	<sql-query name="identityCommand">
		<query-param name="identityID" type="string" />
		<query-param name="deviceId" type="int" />
		<query-param name="version" type="long" />
		<return class="IdentityCommand" />
		SELECT ic.* FROM IDENTITYCOMMAND ic WHERE ic.DEVICEID=:deviceId AND
		ic.VERSION=:version AND ic.IDENTITY_ID=:identityID
	</sql-query>



	<sql-query name="spaceStateForServer">
		<query-param name="serverID" type="string" />
		SELECT w.SPACE_ID,w.SPACESTATEHASH FROM WORKSPACE w LEFT JOIN MEMBER m
		ON
		m.SPACE_ID=w.SPACE_ID LEFT JOIN COLLABERIDENTITY CI ON
		CI.ID=m.USER_ID
		WHERE
		CI.SERVERID=:serverID
	</sql-query>
	<sql-query name="spaceStateForContact">
		<query-param name="memId" type="string" />
		SELECT w.SPACE_ID,w.SPACESTATEHASH FROM WORKSPACE w LEFT JOIN MEMBER m
		ON
		m.SPACE_ID=w.SPACE_ID WHERE m.USER_ID=:memId
	</sql-query>



	<sql-query name="getLastIdentityCommandVersion">
		<query-param name="deviceId" type="int" />
		<query-param name="identityID" type="string" />
		SELECT MAX(ic.VERSION) FROM IDENTITYCOMMAND ic WHERE
		ic.DEVICEID=:deviceId AND ic.IDENTITY_ID=:identityID
	</sql-query>
	<query name="get.identities.by.company">
		<query-param name="companyName" type="string" />
		select c.id from CollaberIdentity c where c.companyName = :companyName
	</query>
	<query name="getAdminEmailId.by.CompanyName">
		<query-param name="companyName" type="string" />
		<query-param name="systemRole" type="string" />
		from CollaberIdentity c where c.companyName = :companyName and
		c.systemRole = :systemRole
	</query>

	<!--		Named SQl for class S2SSyncWorkspacesEvent same query as-->
	<!--		spaceStateForServer above-->



	<!--	 Named SQL for class AbstractSpace -->
	<sql-query name="getSpaceVersions">
		<query-param name="id" type="string" />
		SELECT DISTINCT MEMBER,DEVICE,MAX(VERSION) FROM WORKSPACECOMMAND WHERE
		SPACE_ID=:id GROUP BY MEMBER,DEVICE ORDER BY MEMBER,DEVICE
	</sql-query>

	<sql-query name="getCommandData">
		<query-param name="member" type="string" />
		<query-param name="device" type="int" />
		<query-param name="version" type="long" />
		<query-param name="spaceID" type="string" />
		<return class="com.bizantra.server.ext.WorkspaceCommand" />
		select c.* from WORKSPACECOMMAND c where c.MEMBER=:member and
		c.DEVICE=:device and c.VERSION=:version and c.SPACE_ID=:spaceID
	</sql-query>
	<sql-query name="getNextCount">
		<query-param name="id" type="string" />
		<query-param name="member" type="string" />
		<query-param name="device" type="int" />
		SELECT MAX(VERSION) FROM WORKSPACECOMMAND WHERE SPACE_ID=:id AND
		MEMBER=:member AND DEVICE=:device
	</sql-query>



	<!--	 RestorePointEvent-->
	<query name="workspacecommand.by.spaceid">
		<query-param name="spaceID" type="string" />
		from WorkspaceCommand wc where wc.spaceID=:spaceID order by wc.id
	</query>
	<!--
		<query name="get.root.spaces"> <query-param name="collaberIdentity"
		type="string" /> from WorkSpace ws1 where ws1.id not in (select ws.id
		from SpaceGroup sg inner join sg.spaces ws where sg.id in ( select
		sg1.id from CollaberIdentity ci inner join ci.spaceGroups sg1 where
		ci.id=:collaberIdentity)) </query>
	-->

	<!--	 AbstractSpace -->
	<query name="workspacecommand.by.spaceid.and.memberid">
		<query-param name="memID" type="string" />
		<query-param name="spaceID" type="string" />
		from WorkspaceCommand wc where wc.member=:memID and
		wc.spaceID=:spaceID
	</query>


	<query name="identitycommand.by.deviceid.and.version">
		<query-param name="upto" type="long" />
		<query-param name="device" type="int" />
        <![CDATA[from IdentityCommand where deviceId=:device and version <=:upto]]>
	</query>

	<query name="workspace.by.spaceid">
		<query-param name="spaceid" type="string" />
		from WorkSpace a where a.spaceId=:spaceid
	</query>
	<query name="workspace.by.spaceid.identityID">
		<query-param name="spaceID" type="string" />
		<query-param name="collaberID" type="string" />
		select sp from CollaberIdentity ci inner join ci.spaces sp where
		ci.id=:collaberID and sp.spaceId=:spaceID
	</query>

	<query name="workspace.by.name">
		<query-param name="name" type="string" />
		from WorkSpace a where a.name=:name
	</query>







	
	<sql-query name="create.history.object">
		<query-param name="spaceID" type="string" />
		<query-param name="objectID" type="string" />
		<query-param name="memberID" type="string" />
		<query-param name="name" type="string" />
		<query-param name="category" type="string" />
		<query-param name="createdDate" type="Date" />
		<query-param name="spaceName" type="string" />
		insert into HISTORY_OBJECT(SPACEID, OBJECTID,
		MEMBERID,NAME,CATEGORY,CREATEDDATE,WORKSPACE_NAME) values(:spaceID,
		:objectID, :memberID,:name,:category,:createdDate,:spaceName)
	</sql-query>


	<sql-query name="workspace.ecryptedkey">
		<query-param name="spaceID" type="string" />
		SELECT ENCRYPTED_ID FROM WORKSPACE a WHERE a.SPACE_ID=:spaceID
	</sql-query>
	<sql-query name="identity.ecryptedkey">
		<query-param name="identityID" type="string" />
		SELECT ENCRYPTED_ID FROM COLLABERIDENTITY a WHERE a.ID=:identityID
	</sql-query>

	<query name="get.by.spaceid">
		<query-param name="spaceID" type="string" />
		from WorkSpace where spaceId=:spaceID
	</query>
	<sql-query name="get.allcompany">
		SELECT NAME FROM BIZANTRA_COMPANY
    </sql-query>
	<sql-query name="get.allworkspace">
		SELECT SPACE_ID FROM WORKSPACE
    </sql-query>
	<!--
		<query name="get.allServerDetails"> from SharedServerDetails </query>
	-->
	<query name="get.all.workspace.object">
		from WorkSpace
    </query>




	<sql-query name="get.external.space.id.by.member">
		<query-param name="contactID" type="string" />
		<query-param name="companyName" type="string" />
		select W.SPACE_ID FROM WORKSPACE W INNER JOIN MEMBER M ON
		W.SPACE_ID=M.SPACE_ID WHERE W.ISEXTERNALWORKSPACE=true and
		M.USER_ID=:contactID and M.COMPANYNAME=:companyName GROUP BY
		W.SPACE_ID
	</sql-query>



	<query name="latestcommandsofallspaceswherecurrentuserismember">
		<query-param name="userID" type="string" />

		FROM WorkspaceCommand W WHERE W.spaceID in (select m.space from
		Member
		m where m.userId=:userID) order by W.command.date desc
	</query>

	<query name="latest.commands.of.given.space">
		<query-param name="spaceId" type="string" />

		FROM WorkspaceCommand W WHERE W.spaceID=:spaceId order by
		W.command.date desc

	</query>


	<sql-query name="get.companyname.of.external.member">
		<query-param name="memberID" type="string" />
		SELECT COMPANYNAME FROM MEMBER WHERE USER_ID=:memberID
	</sql-query>

	<sql-query name="get.all.workspace.ids">
		SELECT SPACE_ID FROM WORKSPACE
    </sql-query>

	<sql-query name="commit.disk.usage">
		<query-param name=":size" type="long" />
		UPDATE BIZANTRA_COMPANY SET USED_SIZE=:size
	</sql-query>

	<sql-query name="is.member.in.any.workspace">
		<query-param name="id" type="string" />
		SELECT COUNT(ID) FROM MEMBER WHERE USER_ID=:id
	</sql-query>

</hibernate-mapping>
